<?xml version="1.0"?>
<!-- **********************************************************************-->
<!-- Copyright 2013-2025                                                   -->
<!-- Nicholas Long, Mitchel Keller, Steven Schlicker                       -->
<!--                                                                       -->
<!-- This file is part of Active Calculus Multivariable.                   -->
<!--                                                                       -->
<!-- Permission is granted to copy, distribute and/or modify this document -->
<!-- under the terms of the Creative Commons BY-NC-SA license.  The work   -->
<!-- may be used for free by any party so long as attribution is given to  -->
<!-- the author(s), the work and its derivatives are used in the spirit of -->
<!-- "share and share alike"; no party may sell this work or any of its    -->
<!-- derivatives for profit.  All trademarks are the registered marks of   -->
<!-- their respective owners.                                              -->
<!-- **********************************************************************-->
<section xml:id="S_mv_deriv-chain_rule" xmlns:xi="http://www.w3.org/2001/XInclude">
  <title>The Multivariable Chain Rule</title>
  <objectives>
      <ul>
        <li>
          <p>
            How can we take derivatives involving compositions of multivariable functions?
          </p>
        </li>

        <li>
          <p>
            For locally linear functions, how can a partial derivative of a composition of multivariable functions separate into dependence on the input variables?
          </p>
        </li>
      </ul>
  </objectives>
  <introduction component="instructor">
    <title>Notes to the Instructor and Dependencies</title>
    <p>
      This section use the ideas of partial derivatives and provides an algebraic description for the chain rule (which is used in <xref ref="S-10-6-Directional-Derivative"/>). Some instructors will do a cursory coverage this material, but we relate the concept and development of the chain rule to our tools of linearization from <xref ref="S-mv_deriv-linearization"/>. 
    </p>
  </introduction>
  <subsection>
    <title>Introduction</title>
    <p>
      In single-variable calculus, we encountered situations in which some quantity was related through a composition of related quantities. For instance, suppose <m>P</m> is the price of a product and <m>P</m> depends on the wages <m>x</m> of people making the product. The wages of people making the product will also change over time because of seasonal availability and other factors. So a change in the value of time <m>t</m> produces a change in the value of <m>x</m>, which produces a change in the value of <m>P</m>. This means that we can write <m>P</m> as a function of <m>x</m> and <m>x</m> as a function of <m>t</m>, thus we can express <m>P</m>'s dependence on <m>t</m> by a composition of functions: <m>(P\circ x)(t) = P(x(t))</m>.
    </p> 
    <!-- If restoring this image, there are two lines in the image that need fixing since they broke XML comments.
    <figure xml:id="compositionoffns">
      <caption>Composition of <m>P(x)</m> and <m>x(t)</m> </caption>
      <image width="50%">
        <shortdescription></shortdescription>
        <latex-image>
          \begin{tikzpicture}
          \node[font=\large] (t) at (0, 4) {\(t\)};
          \begin{scope}[xshift=4cm]
          \node[font=\large] (X) at (0, 4) {\(x\)};
          \end{scope}
          \begin{scope}[xshift=8cm]
          \node[font=\large] (P) at (0, 4) {\(P\)};
          \end{scope}
          \draw [->] (t) - - (X) node [pos=0.5, above] {\(x(t)\)}; % FIX ME BY REMOVING THE SPACE BETWEEN THE DASHES
          \draw [->] (X) - - (P) node [pos=0.5, above] {\(P(x)\)}; % FIX ME BY REMOVING THE SPACE BETWEEN THE DASHES
          \draw [->,out=60, in=120, line width=1.5pt, red!80!black] (t) .. controls ++(1, 1) and ++(-1, 1) .. (P) node [pos=0.5, above] {\(P(x(t))= (P \circ x) (t)\)};
          \end{tikzpicture}      
        </latex-image>
      </image>
    </figure>-->
    <p>
      Applying the <url href="https://activecalculus.org/single/sec-2-5-chain.html#chain-rule" >chain rule</url> from single-variable calculus to find the rate of change of the price <m>P</m> with respect to time <m>t</m> likely leads you to write
      <me>
        \frac{dP}{dt} = P'(x(t))x'(t)
      </me>.
      However, this form of the chain rule is only useful when we have algebraic expressions for <m>P(x)</m> and <m>x(t)</m>. It may be that we know about the rate of change of <m>P</m> with respect to <m>x</m> at a specific value <m>x_0</m> and the rate of change of <m>x</m> with respect to <m>t</m> at a specific value <m>t_0</m> for which we have <m>x(t_0)=x_0</m>. Using the language of differentials and local linearity we can express these changes as follows.  For a small change in <m>x</m>, the change in the price of the product is approximately proportional to the change in <m>x</m>:
      <me> dP = \frac{dP}{dx}\restrict{x=x_0} dx  </me>,
      where <m>\frac{dP}{dx}\restrict{x=x_0}</m> denotes the instantaneous rate of change in the product price per unit of labor cost at <m>x=x_0</m>. Similarly, a small change in the value of <m>t</m> will also cause a proportional change in the value of <m>x</m>:
      <me> dx = \frac{dx}{dt}\restrict{t=t_0} dt</me>.
    </p>
    <p>
      We can combine these relationships to express how a change in <m>t</m> produces a change in <m>P</m>:
      <me>dP=\frac{dP}{dx}\restrict{x=x_0} dx =  \left( \frac{dP}{dx}\restrict{x=x_0} \right)\left( \frac{dx}{dt}\restrict{t=t_0} \right) dt</me>
      We should interpret this as telling us that the change in the price of the product is approximately the current instantaneous rate of change of the price per step in <m>x</m> times the current rate of change in the price of labor times the step in time. 
    </p>
    <p>
      As we look at functions of two (or more) variables in this text, we will encounter a situation where <m>z = f(x,y)</m> and both <m>x</m> and <m>y</m> depend on another variable <m>t</m>. A change in <m>t</m> then produces changes in <em>both</em> <m>x</m> and <m>y</m>, which then causes <m>z</m> to change. In this section, we will see how to describe the change in <m>z</m> that is caused by a change in <m>t</m>, leading us to multivariable versions of the chain rule involving both regular and partial derivatives.
    </p>
    <worksheet>
  <exploration workspace="1.5in"
 xml:id="PA-chain">
      <introduction>
        <p>
          Your self-driving car company, <em>Steer Clear</em>, is doing well and almost ready to launch its first car. Some of your engineers have reported that the car has problems when the air intake encounters a large quantity of large particulate matter (sand, dust, large pollen, smog, etc.) in the air. To fix this issue, you have created a new type of filter that uses a sophisticated mesh and gravity to filter out large particulate matter. However, this new type of filter gets clogged if exposed to too much large particulate matter too quickly. To determine the viability of this filter, you must measure the rate at which your car's intake will be exposed to large particulate matter per unit time. 
        </p>
        <p>
          You consult a friend Alex who does atmospheric modeling of large particulate matter in your area. Alex created a function that describes the amount of large particulate matter in the air in terms of location relative to her lab. This function is expressed algebraically as <m>P(x,y)=10-\frac{1}{2} x^2-\frac{1}{5}y^2</m>. Here <m>x</m> is the distance east/west from Alex's lab and <m>y</m> is the distance north/south from her lab. Both distances are measured in kilometers and <m>P</m> is measured in parts per million.
        </p>
        <p>
          Using the self-driving feature of your car, you specify that your car will move along a test course that can be described as
          <me>
            \vr(t) = \langle x(t), y(t) \rangle = \langle 2-t^2, t^3 + 1\rangle
          </me>,
          where the <m>x</m> and <m>y</m> coordinates are the same as measured by Alex's function and <m>t</m> is measured in minutes. 
        </p>
      </introduction>
      <task xml:id="PA-chain-t1">
        <statement>
          <p>
            Substitute the path component functions <m>x(t)</m> and <m>y(t)</m> into the expression for <m>P(x,y)</m> but <alert>do not simplify</alert> the resulting expression for <m>P(t)</m>. This gives a one-variable function that describes the amount of large particulate matter encountered at each location on your test course as a function of <em>time</em>. 
          </p>
        </statement>
      </task>
      <task xml:id="PA-chain-t2">
        <statement>
          <p>
            Use derivative rules from single-variable calculus to find <m>P'(t)=\frac{dP}{dt}</m>. <alert>Do not simplify this expression.</alert> Note that this is <em>not</em> a partial derivative because <m>P(t)</m> only has <em>one</em> dependent variable. 
          </p>
        </statement>
      </task>
      <task xml:id="PA-chain-t3">
        <statement>
          <p>
            Alex has told you that the amount of large particulate matter in the air changes in the <m>y</m>-direction (north/south) because of the proximity to industrial pollution from a factory complex. Also, the amount of large particulate matter in the air changes in the <m>x</m>-direction (east/west) because of tree pollen from a species of tree in a nearby forest. You would like to understand how the rate of large particulate matter encountered on the car's drive is split into these two factors.
          </p>
          <p>
            Alex suggests that you measure <m>\frac{dP}{dt}</m> at a location <m>(x,y)=(a,b)</m> by taking the derivative of the linearization for <m>P</m> at <m>(a,b)</m>. The linearization of <m>P</m> at <m>(a,b)</m> is given by
            <me> L(x,y)=P(a,b)+P_x(a,b)(x-a)+P_y(a,b)(y-b)</me>
            Remember that <m>x=x(t)</m> and <m>y=y(t)</m> are being considered as functions of time in this scenario.
          </p>
          <p>
            Write a couple of sentences to explain why 
            <men xml:id="dLinear">\frac{dP}{dt}\approx\frac{dL}{dt} = 0 + P_x(a,b) \frac{dx}{dt}+P_y(a,b) \frac{dy}{dt}</men> 
            and how <m>P_x(a,b) \frac{dx}{dt}</m> and <m>P_y(a,b) \frac{dy}{dt}</m> measure the rates of change in pollution coming from tree pollen and industrial pollution, respectively. 
          </p>
        </statement>
      </task>
      <task xml:id="PA-chain-t4">
        <statement>
          <p>
            Use the formulas provided at the beginning of the Preview Activity for <m>P(x,y)</m>, <m>x(t)</m>, and <m>y(t)</m> to compute each of the following. Then substitute your expressions into Alex's approximation given in equation <xref ref="dLinear"/>. <alert>Do not simplify this expression.</alert>
            <me>P_x(a,b)\qquad P_x(a,b)\qquad \frac{dx}{dt}\qquad \frac{dy}{dt}\qquad </me>
          </p>
        </statement>
      </task>
      <task>
        <statement>
          <p>
            Compare your results for <xref ref="PA-chain-t2" text="type-local"/> and <xref ref="PA-chain-t4" text="type-local"/> and write a couple of sentences that describe how each part of your answer for <xref ref="PA-chain-t4" text="type-local"/> corresponds to different parts of <xref ref="PA-chain-t2" text="type-local"/>. Remember your work for <xref ref="PA-chain-t2" text="type-local"/> is completely in terms of <m>t</m> so you will need to translate some terms from <m>t</m> into its meaning in other quantities.
          </p>
        </statement>
      </task>
    </exploration>
</worksheet>
  </subsection>
  <subsection>
    <title>The Chain Rule</title>
    <p>
      As <xref ref="PA-mv_deriv-second_order">Preview Activity</xref> suggests, the following version of the chain rule holds in general.
    </p>
    <assemblage xml:id="Chain-rule">
      <title>The Chain Rule</title>
      <p>
        If <m>z = f(x,y)</m> is a differentiable function of <m>x</m> and <m>y</m> and <m>x</m> and <m>y</m> are each differentiable functions of <m>t</m>, then
        <men xml:id="eqn_chain_rule">
          \frac{dz}{dt} = \frac{\partial z}{\partial x} \frac{dx}{dt} + \frac{\partial z}{\partial y} \frac{dy}{dt}
        </men>.
      </p>
    </assemblage>
    <p>
      It is important to note the differences among the derivatives in <xref ref="eqn_chain_rule"/>. Since <m>z</m> is a function of the two variables <m>x</m> and <m>y</m>, the derivatives in the chain rule for <m>z</m> with respect to <m>x</m> and <m>y</m> are <em>partial</em> derivatives. However, since <m>x = x(t)</m> and <m>y = y(t)</m> are functions of the single variable <m>t</m>, their derivatives are the standard derivatives of functions of one variable. When we compose <m>z</m> with <m>x(t)</m> and <m>y(t)</m>, <m>z</m> is represented as a function of the single variable <m>t</m>. Therefore, the derivative of <m>z</m> with respect to <m>t</m> is a derivative from single-variable calculus as well.
    </p>

    <p>
      To understand why this chain rule works in general, suppose that <m>z</m> depends on <m>x</m> and <m>y</m> so
      that we can express the change in <m>z</m> in terms of the differential as
      <men xml:id="eqn_chain_rule_differential1">
        dz = \frac{\partial z}{\partial x} dx + \frac{\partial z}{\partial
            y} dy
      </men>.
      Further suppose that <m>x</m> and <m>y</m> each depend on <m>t</m>, so that
      <men xml:id="eqn_chain_rule_differential2">
        dx = \frac{dx}{dt}~dt
          \ 
          \mbox{and} 
          \ 
          dy = \frac{dy}{dt}~dt
      </men>.
    </p>

    <p>
      Combining equations <xref ref="eqn_chain_rule_differential1"/> and <xref ref="eqn_chain_rule_differential2"/>, we find that
      <me>
        dz = \frac{\partial z}{\partial x}\frac{dx}{dt}~dt 
        + \frac{\partial z}{\partial y}\frac{dy}{dt}~dt = \frac{dz}{dt}~dt,
      </me>
      which is the chain rule in this particular context, as expressed in <xref ref="eqn_chain_rule">equation</xref>.
    </p>
    <p>
      This approach to understanding the change in <m>z</m> using the differential or linearization also separates how much of the change in <m>x</m> is coming through each of the intermediate variables <m>x</m> and <m>y</m>. In the context of the <xref ref="PA-chain">Preview Activity</xref> where <m>P</m> is the amount of the large particulate matter in the air as function of location <m>(x,y)</m> and location is changing according to time along the path <m>\vr(t)=\langle x(t),y(t)\rangle </m>, the chain rule expresses the rate of change in <m>P</m> as a function of time as 
      <me>\frac{dP}{dt} =  \frac{\partial P}{\partial x} \frac{dx}{dt}+ \frac{\partial P}{\partial y} \frac{dy}{dt}</me>.
    </p>
    <p>
      Because the amount of large particulate matter in terms of the <m>x</m>-coordinate is governed by tree pollen, the term <m>\frac{\partial P}{\partial x} \frac{dx}{dt}</m> describes the rate of change in the large particulate matter per unit time along our drive attributable to tree pollen. Similarly, the amount of large particulate matter in terms of the <m>y</m>-coordinate is governed by industrial pollution. Hence, the second term <m>\frac{\partial P}{\partial y} \frac{dy}{dt}</m> describes the rate of change in the large particulate matter per unit time along our drive attributable to industrial pollution. Because this function is locally linear, the total rate of change in large particulate matter is the sum of these individual rates of change. 
    </p>

    <worksheet>
  <activity workspace="1.5in" xml:id="act-mv_deriv-chain_rule">
    <introduction>
      <p>
         In the following questions, we apply the chain rule in several different contexts.
      </p>
    </introduction>
    <task>
      <statement>
        <p>
          Suppose <m>z(x,y) = x^2+xy^3</m>.  In addition, suppose that <m>x</m> and <m>y</m> are restricted to points that move around the plane by following a circle of radius <m>2</m> centered at the origin that is parameterized by
          <me> x(t) = 2\cos(t), \  \mbox{ and } \  y(t) = 2\sin(t) </me>.
          <ol marker="i.">
            <li>
              <p>
                Use the chain rule to find the instantaneous rate of change <m>\frac{dz}{dt}</m>.
              </p>
            </li>
            <li>
              <p>
                Substitute <m>x(t)</m> for <m>x</m> and <m>y(t)</m> for <m>y</m> in the rule for <m>z</m> to write <m>z</m> in terms of <m>t</m> and calculate <m>\frac{dz}{dt}</m> using only techniques from single-variable calculus. 
              </p>
            </li>
            <li>
              <p>
                Write a couple of sentences comparing your answers above.
              </p>
            </li>
          </ol>
        </p>
      </statement>
      <answer>
        <p>
          <ol marker="i.">
            <li>
              <p>
                <me>
                  \frac{dz}{dt} = (4\cos(t) + 8\sin^3(t))(-2\sin(t)) + 48 \cos^2(t)\sin^2(t)
                </me>
              </p>
            </li>
            <li>
              <p>
                <me>
                  \frac{dz}{dt} = 8 \cos(t) (-\sin(t)) + 16 \left [ (\cos(t)) (3\sin^2(t)\cos(t)) - \sin^4(t) \right]
                </me>
                
              </p>
            </li>
            <li>
              <p>
                They are equal.
              </p>
            </li>
          </ol>
        </p>
      </answer>
      <solution>
        <p>
          <ol marker="i.">
            <li>
              <p>
                According to the chain rule we have
                <me>
                  \frac{dz}{dt} = (4\cos(t) + 8\sin^3(t))(-2\sin(t)) + 48 \cos^2(t)\sin^2(t)
                </me>.
              </p>
            </li>
            <li>
              <p>
                <me>
                  \frac{dz}{dt} = 8 \cos(t) (-\sin(t)) + 16 \left [ (\cos(t)) (3\sin^2(t)\cos(t)) - \sin^4(t) \right]
                </me>
                
              </p>
            </li>
            <li>
              <p>
                This is the same as the derivative above.
              </p>
            </li>
          </ol>
        </p>
      </solution>
    </task>
    <task>
      <statement>
        <p>
          Suppose that the temperature on a metal plate is given by the function <m>T</m> with
          <me> T(x,y) = 100-(x^2 + 4y^2)  </me>
          where the temperature is measured in degrees Fahrenheit and <m>x</m> and <m>y</m> are each measured in feet.
          <ol marker="i.">
            <li>
              <p>
                Find <m>T_x</m> and <m>T_y</m>.  What are the units on these partial derivatives?
              </p>
            </li>
            <li>
              <p>
                Suppose an ant is walking along the <m>x</m>-axis at the rate of 2 feet per minute toward the origin.  When the ant is at the point <m>(2,0)</m>, what is the instantaneous rate of change in the temperature <m>dT/dt</m> that the ant experiences. Include units on your response.
              </p>
            </li>
            <li>
              <p>
                Suppose instead that the ant walks along the ellipse <m>\vr(t) = \langle  6\cos(t), 3\sin(t)\rangle</m>, where <m>t</m> is measured in minutes. Use the multivariable chain rule to find <m>\frac{dT}{dt}</m>. What does this tell you about the path along which the ant is walking?
              </p>
            </li>
          </ol>
        </p>
      </statement>
      <answer>
        <p>
          <ol marker="i.">
            <li>
              <p>
                <md>
                  <mrow>T_x(x,y) \amp = -2x</mrow>
                  <mrow>T_y(x,y) \amp = -8y</mrow>
                </md>,
                both measured in units of degrees Fahrenheit per foot.
              </p>
            </li>
            <li>
              <p>
                <me>
                  \frac{dT}{dt}\restrict{(2,0)} = -8 \frac{^{\circ}F}{\text{ min } }
                </me>
              </p>
            </li>
            <li>
              <p>
                <m>\frac{dT}{dt} = 0</m>, so on the path the ant is walking the temperature is constant.
              </p>
            </li>
          </ol>
        </p>
      </answer>
      <solution>
        <p>
          <ol marker="i.">
            <li>
              <p>
                <md>
                  <mrow>T_x(x,y) \amp = -2x</mrow>
                  <mrow>T_y(x,y) \amp = -8y</mrow>
                </md>,
                both measured in units of degrees Fahrenheit per foot.
              </p>
            </li>
            <li>
              <p>
                <me>
                  \frac{dT}{dt}\mid_{(2,0)} = -8 \frac{^{\circ}F}{\text{ min } }
                </me>
              </p>
            </li>
            <li>
              <p>
                In this case we have
                <md>
                  <mrow>\frac{dT}{dt} \amp = \frac{\partial T}{\partial x} \frac{dx}{dt} + \frac{\partial T}{\partial y} \frac{dy}{dt}</mrow>
                  <mrow>\amp = (-2x)(-6\sin(t)) - (8y)(3\cos(t))</mrow>
                  <mrow>\amp = 72\cos(t)\sin(t) - 72 \sin(t)\cos(t)</mrow>
                  <mrow>\amp = 0</mrow>
                </md>.
                The fact that <m>\frac{dT}{dt} = 0</m> means that <m>T</m> is not changing, so on the path the ant is walking the temperature is constant. Note that
                <me>
                  T(6\cos(t), 3\sin(t)) = 100 - (36\cos^2(t) + 36\sin^2(t)) = 100-36 = 64
                </me>,
                so the ant is walking along a path of constant temperature <m>64^{\circ}F</m>.
              </p>
            </li>
          </ol>
        </p>
      </solution>
    </task>
    <task>
      <statement>
        <p>
          Suppose that you are walking along a surface whose elevation is given by a function <m>f</m>. Some contours of <m>f</m> are as shown in the image below. Furthermore, suppose that if you consider how your location corresponds to points in the <m>xy</m>-plane, you know that when you pass the point <m>(2,1)</m>, your velocity vector is <m>\vv=\langle -1,2\rangle</m>.  Estimate the rate of change <m>df/dt</m> when you pass through <m>(2,1)</m>.
        </p>
        <image width="50%" source="images/fig_10_3_activity_contour"/>
      </statement>
      <answer>
        <p>
          <me>
            \frac{df}{dt}\restict{(2,1)} \approx 4.05
          </me>
        </p>
      </answer>
      <solution>
        <p>
          Since
          <me>
            \frac{df}{dt}= \frac{\partial f}{\partial x} \frac{dx}{dt} + \frac{\partial f}{\partial y} \frac{dy}{dt}
          </me>,
          we need to estimate <m>\frac{\partial f}{\partial x}</m> and <m>\frac{\partial f}{\partial y}</m> at <m>(2,1)</m>.
          Now
          <md>
            <mrow>f_x(2,1) \amp \approx \frac{f(3,1) - f(1,1)}{2} \approx \frac{1.9-4.8}{2} = -1.45</mrow>
            <mrow>f_y(2,1) \amp \approx \frac{f(2,2) - f(2,0)}{2} \approx \frac{4.4-1.8}{2} = 1.3</mrow>
          </md>.
          The velocity vector at the point <m>(2,1)</m> tells us <m>\frac{dx}{dt}</m> and
          <m>\frac{dy}{dt}</m> at the point <m>(2,1)</m>, so
          <me>
            \frac{df}{dt}\restrict{(2,1)} \approx -1.45(-1) + 1.3(2) = 4.05
          </me>.
        </p>
      </solution>
    </task>  
  </activity>
</worksheet>
  <p>
    The previous activity and discussion have all dealt with a multivariable function where each input of the function depends on a single variable <m>t</m>. The next example generalizes the concept of the chain rule for multivariable functions. We show how the multivariable chain rule can be applied to functions with more than two input variables as well as the situation where the input variables depend on more than one other variable.
  </p>
  <example>
    <p>
      Let <m>C</m> be the cost to manufacture flibertygibbits. The cost to produce flibertygibbits depends on the costs of two parts, which we will call <m>p</m> and <m>q</m>, and the cost of labor to construct the flibertygibbits, which we will call <m>L</m>. This means that <m>C</m> is a multivariable function of <m>p</m>, <m>q</m>, and <m>L</m>, which we will denote <m>C(p,q,L)</m>. The part costs and the labor costs each depend on the distance <m>s</m> to nearby suppliers and cities and time <m>t</m>. This means that <m>p</m>, <m>q</m>, and <m>L</m> are themselves multivariable functions of <m>s</m> and <m>t</m>. In other words, we need to consider <m>p(s,t)</m>, <m>q(s,t)</m>, and <m>L(s,t)</m>.
    </p>
    <p>
      To find how the cost to produce flibertygibbits depends on changes in <m>s</m> or <m>t</m>, we can use the chain rule. We can look at the differential of <m>C</m> to determine how these dependencies affect each other. This differential can be expressed as
      <me>dC = \frac{\partial C}{\partial p} dp + \frac{\partial C}{\partial q} dq + \frac{\partial C}{\partial L} dL</me>,
      and it describes how a change in <m>C</m> depends on changes in each variable <m>p</m>, <m>q</m>, and <m>L</m>.
    </p>
    <p>
       We can look at how this change in <m>C</m> depends on either <m>s</m> or <m>t</m> considering the differentials <m>dC</m>, <m>dp</m>, <m>dq</m>, and <m>dL</m> via the appropriate partial derivatives with respect to <m>s</m> or <m>t</m>. In particular, we have
       <me>\frac{\partial C}{\partial s} = \frac{\partial C}{\partial p} \frac{\partial p}{\partial s} + \frac{\partial C}{\partial q} \frac{\partial q}{\partial s} + \frac{\partial C}{\partial L} \frac{\partial L}{\partial s} </me> 
       and 
       <me>\frac{\partial C}{\partial t} = \frac{\partial C}{\partial p} \frac{\partial p}{\partial t} + \frac{\partial C}{\partial q} \frac{\partial q}{\partial t} + \frac{\partial C}{\partial L} \frac{\partial L}{\partial t} </me>.
    </p>
    <p>
      These chain rule expressions have the same separation of intermediate variables as in our earlier discussion. For instance, the term <m>\frac{\partial C}{\partial q} \frac{\partial q}{\partial s} </m> describes the rate of change in the cost of making flibertygibbits per unit of distance from other cities that depends on the cost of part <m>q</m>. The term <m>\frac{\partial C}{\partial L} \frac{\partial L}{\partial t} </m> describes the rate of change in the cost of making flibertygibbits per unit time that depends on the cost of labor <m>L</m>. In both cases, the partial derivatives of <m>C</m> with respect to <m>s</m> and <m>t</m> are a linear combination of the changes through each of the intermediate variables <m>p</m>, <m>q</m>, and <m>L</m>.
    </p>
  </example>
  <p>
    The chain rule and local linearity are related, conceptually-significant ideas. Every version of the chain rule we have seen, including the chain rule from single-variable calculus, ultimately states that the change in an output variable is a linear combination of the instantaneous rates of change of each input variable and the step size of that variable. The chain rule is an algebraic statement of this linear combination. Recall from the previous section that when a function is locally linear, the instantaneous rate of change of the function is the same as the corresponding measurement of change along the linearization/tangent plane.
  </p>
  </subsection>


  

  <subsection>
    <title>Summary</title>
    <ul>
      <li>
        <p>
          The Chain Rule is a tool for differentiating a composite for functions.  In its simplest form, it says that if <m>f(x,y)</m> is a function of two variables and <m>x(t)</m> and <m>y(t)</m> depend on <m>t</m>, then
          <me>
            \frac{df}{dt} = \frac{\partial f}{\partial x}\frac{dx}{dt} + \frac{\partial f}{\partial y}\frac{dy}{dt}.
          </me>
        </p>
      </li>
      <li>
        <p>
          The Chain Rule generalizes to functions of more than two variables and functions with more than one independent variable. If <m>g(x,y,z)</m> is a function of three variables and each of <m>x</m>, <m>y</m>, and <m>z</m> depend on <m>s</m> and <m>t</m>, then 
          <me>\frac{\partial g}{\partial s} = \frac{\partial g}{\partial x} \frac{\partial x}{\partial s} + \frac{\partial g}{\partial y} \frac{\partial y}{\partial s} + \frac{\partial g}{\partial z} \frac{\partial a}{\partial s} </me> 
          and 
          <me>\frac{\partial g}{\partial t} = \frac{\partial g}{\partial x} \frac{\partial x}{\partial t} + \frac{\partial g}{\partial y} \frac{\partial y}{\partial t} + \frac{\partial g}{\partial z} \frac{\partial z}{\partial t} </me>
        </p>
      </li>

      <!-- <li>
        <p>
          A tree diagram can be used to represent the dependence of variables on other variables. By following the links in the tree diagram, we can form chains of partial derivatives or derivatives that can be combined to give a desired partial derivative.
        </p>
      </li> -->
    </ul>

    </subsection>


    <xi:include href="exercises/ez-S_mv_chainrule.ptx" />




    <!-- <subsection>
    <title>Tree Diagrams</title>
    <p>
      Up to this point, we have applied the Chain Rule to situations where
      we have a function <m>z</m> of variables <m>x</m> and <m>y</m>, with both <m>x</m> and <m>y</m> depending on another single
      quantity <m>t</m>. We may apply the Chain Rule, however, when <m>x</m> and <m>y</m> each
      depend on more than one quantity, or when <m>z</m> is a function of more than two variables. It can be challenging to keep track
      of all the dependencies among the variables, and thus a tree diagram can be a useful tool to organize our work.
      For example, suppose that <m>z</m> depends on <m>x</m> and <m>y</m>, and <m>x</m> and <m>y</m>
      both depend on <m>t</m>. We may represent these relationships using the tree
      diagram shown at left <xref ref="F_10_5_tree_1">Figure</xref>. We place the dependent
      variable at the top of the tree and connect it to the variables on
      which it depends one level below. We then connect each of those variables to the variable on which each depends.
    </p>

    <figure xml:id="F_10_5_tree_1">
      <caption>A tree diagram illustrating dependencies.</caption>
      <sidebyside widths="50% 50%">
      <image source="images/fig_10_5_tree_3"/>
      <image source="images/fig_10_5_tree_1"/>
      </sidebyside>
    </figure>

    <p>
      To represent the Chain Rule, we label every edge of the diagram with the
      appropriate derivative or partial derivative, as seen at right in <xref ref="F_10_5_tree_1">Figure</xref>. To calculate an overall derivative according to the Chain Rule, we
      construct the product of the derivatives along all paths connecting
      the variables and then add all of these products.
      For example, the
      diagram at right in <xref ref="F_10_5_tree_1">Figure</xref> illustrates the Chain Rule
      <me>
        \frac{dz}{dt} = \frac{\partial z}{\partial x}\frac{dx}{dt} +
        \frac{\partial z}{\partial y}\frac{dy}{dt}.
      </me>
    </p>

    <worksheet>
  <activity workspace="1.5in" xml:id="PA_10_13">
      <statement>
        <ol marker="a.">
          <li>
            <p>
              <xref ref="F_10_5_tree_2">Figure</xref> shows the tree diagram we construct when (a) <m>z</m> depends on <m>w</m>, <m>x</m>, and <m>y</m>, (b) <m>w</m>, <m>x</m>, and <m>y</m> each depend on <m>u</m> and <m>v</m>, and (c) <m>u</m> and <m>v</m> depend on <m>t</m>.

              <figure xml:id="F_10_5_tree_2">
                <caption>Three levels of dependencies</caption>
                <image width="50%" source="images/fig_10_5_tree_2"/>
              </figure>

              <ol marker="i.">
                <li>
                  <p>
                    Label the edges with the appropriate derivatives.
                  </p>
                </li>

                <li>
                  <p>
                    Use the Chain Rule to write <m>\frac{dz}{dt}</m>.
                  </p>
                </li>
              </ol>
            </p>
          </li>

          <li>
            <p>
              Suppose that <m>z=x^2 - 2xy^2</m> and that
              <md>
                <mrow>x\amp =r\cos(\theta)</mrow>
                <mrow>y\amp =r\sin(\theta).</mrow>
              </md>
              <ol marker="i.">
                <li>
                  <p>
                    Construct a tree diagram representing the dependencies of <m>z</m> on <m>x</m> and <m>y</m> and <m>x</m> and <m>y</m> on <m>r</m> and <m>\theta</m>.
                  </p>
                </li>

                <li>
                  <p>
                    Use the tree diagram to find <m>\frac{\partial z}{\partial r}</m>.
                  </p>
                </li>

                <li>
                  <p>
                    Now suppose that <m>r = 3</m> and <m>\theta=\pi/6</m>. Find the values of <m>x</m> and <m>y</m> that correspond to these given values of <m>r</m> and <m>\theta</m>, and then use the Chain Rule to find the value of the partial derivative <m>\frac{\partial z}{\partial \theta}\restrict{(3,\frac{\pi}{6})}</m>.
                  </p>
                </li>
              </ol>
            </p>
          </li>
        </ol>
      </statement>

      <answer>
        <ol marker="a.">
          <li>
            <ol marker="i">
              <li>
                <p>
                  A labeled tree diagram is shown here.
                </p>
                <image source="images/PA_10_13_partai.png"/>
              </li>
              <li>
                <p>
                  According to the Chain Rule we have
                  <me>
                    \frac{dz}{dt} = \frac{\partial z}{\partial w}\frac{\partial w}{\partial u}\frac{du}{dt} + \frac{\partial z}{\partial w}\frac{\partial w}{\partial v}\frac{dv}{dt} + \frac{\partial z}{\partial x}\frac{\partial x}{\partial u}\frac{du}{dt} + \frac{\partial z}{\partial x}\frac{\partial x}{\partial v}\frac{dv}{dt} + \frac{\partial z}{\partial y}\frac{\partial y}{\partial u}\frac{du}{dt} + \frac{\partial z}{\partial y}\frac{\partial y}{\partial v}\frac{dv}{dt}
                  </me>.
                </p>
              </li>
            </ol>
          </li>
          <li>
            <ol marker="i">
              <li>
                <p>
                  A tree diagram is shown here.
                </p>
                <image source="images/PA_10_13_partbi.png"/>
              </li>
              <li>
                <p>
                  By the Chain Rule we have
                  <me>
                    \frac{\partial z}{\partial r} = \frac{\partial z}{\partial x}\frac{\partial x}{\partial r} + \frac{\partial z}{\partial y}\frac{\partial y}{\partial r}
                  </me>.
                </p>
              </li>
              <li>
                <p>
                  First note that <m>x(3,\pi/6) = 3\frac{\sqrt{3}}{2}</m> and <m>y(3,\pi/6) = \frac{3}{2}</m>.
                  Given that <m>z_x = 2x-2y^2</m> and <m>z_y = -4xy</m> we have
                  <m>z_x(3, \pi/6)=3\sqrt{3}-3</m> and <m>z_y(3,\pi/6) = -9\sqrt{3}</m>.
                  Also, <m>x_r=\cos(\theta)</m> and <m>y_r = \sin(\theta)</m>,
                  so <m>x_r(3,\pi/6) = \frac{\sqrt{3}}{2}</m> and <m>y_r(3,\pi/6) = \frac{1}{2}</m>.
                  So
                  <me>
                    \frac{\partial z}{\partial \theta}\mid_{(3,\frac{\pi}{6})} = (3\sqrt{3}-3)\left(\frac{\sqrt{3}}{2}\right) - 9\sqrt{3}\left(\frac{1}{2}\right)
                  </me>.
                </p>
              </li>
            </ol>
          </li>
        </ol>
      </answer>

      <solution>
        <ol marker="a.">
          <li>
            <ol marker="i">
              <li>
                <p>
                  A labeled tree diagram is shown here.
                </p>
                <image source="images/PA_10_13_partai.png"/>
              </li>
              <li>
                <p>
                  According to the Chain Rule we have
                  <me>
                    \frac{dz}{dt} = \frac{\partial z}{\partial w}\frac{\partial w}{\partial u}\frac{du}{dt} + \frac{\partial z}{\partial w}\frac{\partial w}{\partial v}\frac{dv}{dt} + \frac{\partial z}{\partial x}\frac{\partial x}{\partial u}\frac{du}{dt} + \frac{\partial z}{\partial x}\frac{\partial x}{\partial v}\frac{dv}{dt} + \frac{\partial z}{\partial y}\frac{\partial y}{\partial u}\frac{du}{dt} + \frac{\partial z}{\partial y}\frac{\partial y}{\partial v}\frac{dv}{dt}
                  </me>.
                </p>
              </li>
            </ol>
          </li>
          <li>
            <ol marker="i">
              <li>
                <p>
                  A tree diagram is shown here.
                </p>
                <image source="images/PA_10_13_partbi.png"/>
              </li>
              <li>
                <p>
                  By the Chain Rule we have
                  <me>
                    \frac{\partial z}{\partial r} = \frac{\partial z}{\partial x}\frac{\partial x}{\partial r} + \frac{\partial z}{\partial y}\frac{\partial y}{\partial r}
                  </me>.
                </p>
              </li>
              <li>
                <p>
                  First note that <m>x(3,\pi/6) = 3\frac{\sqrt{3}}{2}</m> and <m>y(3,\pi/6) = \frac{3}{2}</m>.
                  Given that <m>z_x = 2x-2y^2</m> and <m>z_y = -4xy</m> we have
                  <m>z_x(3, \pi/6)=3\sqrt{3}-3</m> and <m>z_y(3,\pi/6) = -9\sqrt{3}</m>.
                  Also, <m>x_r=\cos(\theta)</m> and <m>y_r = \sin(\theta)</m>,
                  so <m>x_r(3,\pi/6) = \frac{\sqrt{3}}{2}</m> and <m>y_r(3,\pi/6) = \frac{1}{2}</m>.
                  So
                  <me>
                    \frac{\partial z}{\partial \theta}\mid_{(3,\frac{\pi}{6})} = (3\sqrt{3}-3)\left(\frac{\sqrt{3}}{2}\right) - 9\sqrt{3}\left(\frac{1}{2}\right)
                  </me>.
                </p>
              </li>
            </ol>
          </li>
        </ol>
      </solution>  
      
    </activity>
</worksheet>
  </subsection> -->
</section>
